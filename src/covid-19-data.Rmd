---
title: "COVID-19 Analytics"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  github_document:
    toc: true
    toc_depth: 2
    fig_width: 12 
    fig_height: 8 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r import_dependecies, include=FALSE}
options(max.print = 1e3, scipen = 999, width = 1e2)
options(stringsAsFactors = F)

suppressPackageStartupMessages({
  # data manipulations
  library(dplyr)
  library(tidyr)
  library(purrr)
  library(magrittr)
  
  # convert and formatting
  library(stringr)
  library(lubridate)
  
  # tools
  library(skimr)
  
  # graphics
  library(ggplot2)
  library(ggthemes)
})
```


```{r set_params, include=FALSE}
caption <- "Data source: Novel Corona Virus 2019 Dataset. \n© 2020, Dmitry Petukhov. CC BY-SA 4.0 license."
```


## Load dataset

Get list of files in datasets container:

```{r}
input_data_container <- "../input/novel-corona-virus-2019-dataset.zip"

print(
  as.character(unzip(input_data_container, list = T)$Name)
)
```

Load `covid_19_data.csv` dataset:
```{r}
covid_data <- read.csv(unz(input_data_container, "covid_19_data.csv"), 
                       na.strings = c("NA", "None", ""),
                       header = T, sep = ",")

covid_data %>% sample_n(100) %>% as_tibble
```

Get dataset structure:
```{r}
str(covid_data)
```



## Preprocessing data

Set `area` column, processing `province_state` columns, and format dates columns:
```{r}
# repair names
names(covid_data) <- names(covid_data) %>% str_replace_all(fixed("."), "_") %>% str_to_lower

covid_data %<>% 
  rename(observation_date = observationdate) %>% 
  mutate(
    ## location processing
    province_state = str_trim(province_state),
    area = as.factor(
      case_when(
        province_state == "Hubei" ~ "Hubei",
        country_region == "US" ~ "US",
        str_detect(country_region, "China") ~ "China without Hubei",
        TRUE ~ "Rest of World")),
    
    ## dates processing
    observation_date = mdy(observation_date),
    last_update = parse_date_time(str_replace_all(last_update, "T", " "), 
                                  orders = c("%Y-%m-%d %H:%M:%S", "m/d/y %H:%M"))
  )
  

covid_data %>% as_tibble
```

Get dataset structure after preprocessing:
```{r}
covid_data %>% skim_to_wide
```



## COVID-19 spread

Get virus spread statistics grouped by `area`:

### Prepare data

Calculate total infected, recovered, and fatal cases:

```{r}
spread_df <- covid_data %>% 
  group_by(
    area, observation_date
  ) %>% 
  summarise(
    confirmed_total = sum(confirmed),
    deaths_total = sum(deaths),
    recovered_total = sum(recovered)
  ) %>% 
  mutate(
    active_total = confirmed_total - (recovered_total + deaths_total)
  )

spread_df %>% arrange(desc(observation_date))
```


### Visualize

```{r}
# TODO: add color legend

ggplot(spread_df, aes(observation_date)) +
  
  geom_col(aes(y = confirmed_total), alpha = .75, fill = "grey") +
  geom_col(aes(y = recovered_total), alpha = .75, fill = "gold") +
  geom_col(aes(y = -deaths_total), alpha = .75, fill = "black") +

  scale_x_date(date_labels = "%d %b", date_breaks = "7 days") +
  scale_color_discrete(name = "Infected cases") +

  labs(x = "", y = "Number of cases", 
       title = "COVID-19 Spread", 
       subtitle = "Virus spread by Hubei, China (without Hubei), US, and Rest of World. \n* Grey bar - all infected cases; gold bar - all recovered cases; black bar - all fatal cases.", 
       caption = caption) +
  
  theme_minimal() +
  theme(legend.position = "top")
```



## Dynamics of Infection

Get daily dynamics of new infected and recovered cases.

### Prepare data

```{r}
covid_daily <- spread_df %>% 
  ## calc cases per day stats
  mutate_at(
    vars(ends_with("_total")),
    list("per_day" = ~ (. - lag(.)))
  ) %>% 
  ungroup() %>% 
  ## calс infected and retired cases
  transmute(
    area, observation_date,
    retired_per_day = recovered_total_per_day + deaths_total_per_day,
    infected_per_day = confirmed_total_per_day
  ) %>% 
  mutate_at(
    vars(ends_with("_per_day")), 
    list(~ replace_na(., 0))
  )
  
covid_daily %>% 
  filter(area == "Hubei") %>% 
  arrange(desc(observation_date))
```


### Visualize

```{r}

# TODO: diifernt clors for fatal and recovered

ggplot(covid_daily, aes(x = observation_date)) +
  
  geom_col(aes(y = -retired_per_day), fill = "gold", alpha = .7) +
  geom_col(aes(y = infected_per_day), fill = "black", alpha = .7) +
  geom_smooth(aes(y = infected_per_day - retired_per_day), method = "loess", color = "grey", alpha = .25) +
  
  facet_grid(area ~ ., scale = "free") +
  
  labs(title = "COVID-19 New Cases", 
       subtitle = "Daily dynamics by Hubei, China (without Hubei), US, and Rest of World. \n* Lines - active cases; gold bar - recovered and fatal cases; black bar - infected cases.", 
       x = "", y = "Number of cases per day",
       caption = caption) +
  
  theme_minimal()
```


## Mortality rate

### Prepare data

```{r}
mortality_df <- covid_data %>% 
  group_by(area, observation_date) %>% 
  summarise(
    confirmed_total = sum(confirmed),
    deaths_total = sum(deaths),
    recovered_total = sum(recovered)
  ) %>% 
  ungroup() %>% 
  inner_join(
    covid_data %>% 
      filter(deaths > 10) %>% 
      group_by(area) %>% 
      summarise(reference_date = min(observation_date)),
    by = "area"
  ) %>% 
  mutate(
    confirmed_deaths_rate = deaths_total/confirmed_total,
    recovered_deaths_rate = deaths_total/(recovered_total + deaths_total),
    n_days = observation_date %>% difftime(reference_date, units = "days") %>% as.numeric
  ) %>% 
  filter(n_days >= 0)


mortality_df %>% 
  filter(area == "US") %>% 
  arrange(desc(observation_date)) %>% 
  select(area, ends_with("_date"), recovered_total, contains("deaths_"))
```


### Visualize

```{r}
ggplot(mortality_df, aes(x = n_days)) +
  geom_area(aes(y = recovered_deaths_rate), alpha = .75, fill = "gold") +
  geom_area(aes(y = confirmed_deaths_rate), alpha = .75, fill = "black") +
  
  scale_y_continuous(labels = scales::percent_format(accuracy = .1)) +
  
  facet_grid(area ~ ., scales = "free") +
  
  labs(x = "Number of days since 10th fatal case", y = "Mortality rate", 
       title = "COVID-19 Mortality Rate", 
       subtitle = "Rate by Hubei, China (without Hubei), US, and Rest of World. \n* Gold area - fatal to recovered cases ratio, grey area - fatal to infected cases ratio.", 
       caption = caption) +
  
  theme_minimal()
```

```{r}
ggplot(mortality_df, aes(x = n_days)) +
  
  geom_hline(aes(yintercept = mean(mortality_df$confirmed_deaths_rate)), linetype = "dashed", color = "black", alpha = .33) +
  annotate(geom = "text", label = "Mean mortality rate (all time)", x = 4, y = mean(mortality_df$confirmed_deaths_rate), vjust = -1) +
  geom_line(aes(y = confirmed_deaths_rate, color = area), size = 1, alpha = .75) +

  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  
  labs(x = "Number of days since 10th fatal case", y = "Mortality rate", 
       title = "COVID-19 Mortality Rate", 
       subtitle = "Fatal to infected cases ratio by Hubei, China (without Hubei), US, and Rest of World", 
       caption = caption) +
  
  theme_minimal() +
  theme(legend.position = "top", 
        legend.title = element_blank())

```

```{r}
ggplot(mortality_df, aes(x = n_days)) +
  
  geom_hline(aes(yintercept = mean(mortality_df$recovered_deaths_rate)), linetype = "dashed", color = "black", alpha = .33) +
  annotate(geom = "text", label = "Mean mortality rate (all time)", x = 4, y = mean(mortality_df$recovered_deaths_rate), vjust = -1) +
  geom_line(aes(y = recovered_deaths_rate, color = area), size = 1, alpha = .75) +

  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  
  labs(x = "Number of days since 10th fatal case", y = "Mortality rate", 
       title = "COVID-19 Mortality Rate", 
       subtitle = "Fatal to recovered cases ratio by Hubei, China (without Hubei), US, and Rest of World", 
       caption = caption) +
  
  theme_minimal() +
  theme(legend.position = "top", 
        legend.title = element_blank())
```


## World population

### Load world population

Get datasets list:

```{r}
world_population_data_container <- "../input/world-population-19602018.zip"
print(
  as.character(unzip(world_population_data_container, list = T)$Name)
)
```

Load world population dataset:

```{r}
world_population <- read.csv(unz(world_population_data_container, "population_clean.csv"),
                             header = T, sep = ",")
str(world_population)
```

Select relevant columns:

```{r}
world_population_2018 <- world_population %>%
  transmute(
    country = Country.Name,
    n = X2018
  )

world_population_2018 %>% as_tibble
```


### Preprocessing

Get not matched countries:

```{r}
not_matched_countries <- setdiff(
  unique(covid_data$country_region),
  unique(world_population_2018$country)
)

covid_data %>% 
  filter(country_region %in% not_matched_countries) %>% 
  group_by(country_region) %>% 
  summarise(n = sum(confirmed)) %>% 
  filter(n > 1000) %>% 
  arrange(-n)
```

Correct top of unmached countries:

```{r}
world_population_2018[world_population_2018$country == "China", ]$country <- "Mainland China"
world_population_2018[world_population_2018$country == "Iran, Islamic Rep.", ]$country <- "Iran"
world_population_2018[world_population_2018$country == "Korea, Rep.", ]$country <- "South Korea"
world_population_2018[world_population_2018$country == "United States", ]$country <- "US"
world_population_2018[world_population_2018$country == "United Kingdom", ]$country <- "UK"
world_population_2018[world_population_2018$country == "Hong Kong SAR, China", ]$country <- "Hong Kong"
world_population_2018[world_population_2018$country == "Egypt, Arab Rep.", ]$country <- "Egypt"
world_population_2018[world_population_2018$country == "Russian Federation", ]$country <- "Russia"
```


Test updated matching:

```{r}
not_matched_countries <- setdiff(
  unique(covid_data$country_region),
  unique(world_population_2018$country)
)

covid_data %>% 
  filter(country_region %in% not_matched_countries) %>% 
  group_by(country_region) %>% 
  summarise(n = sum(confirmed)) %>% 
  filter(n > 1000) %>% 
  arrange(-n)
```

Much better :)



## Enrich COVID dataset with world population

### Infected, recovered, fatal, and active cases

Calculate number of infected, recovered, fatal, and active cases grouped by country:

```{r}
countries_cases <- covid_data %>% 
  ## calc number of infected, recovered, and fatal cases by country
  group_by(country_region, observation_date) %>% 
  summarise(
    confirmed_total = sum(confirmed),
    recovered_total = sum(recovered),
    deaths_total = sum(deaths)
  ) %>% 
  mutate(
    active_total = confirmed_total - (recovered_total + deaths_total)
  ) %>% 
  ungroup() %>% 
  
  ## calc number of days since first infected case
  inner_join(
    covid_data %>% 
      group_by(country_region) %>% 
      filter(confirmed > 0) %>% 
      summarise(first_confirmed_date = min(observation_date)),
    by = "country_region"
  ) %>%
  mutate(
    n_days_since_1st_confirmed = observation_date %>% difftime(first_confirmed_date, units = "days") %>% as.numeric
  ) %>% 
  filter(n_days_since_1st_confirmed >= 0) %>% 
  
  ## calc number of days since 10-th fatal case
  left_join(
    covid_data %>% 
      group_by(country_region, observation_date) %>% 
      summarise(deaths_total = sum(deaths)) %>% 
      filter(deaths_total > 0) %>% 
      summarise(first_deaths_case_date = min(observation_date)),
    by = "country_region"
  ) %>% 
  mutate(
    n_days_since_1st_deaths = observation_date %>% difftime(first_deaths_case_date, units = "days") %>% as.numeric,
    n_days_since_1st_deaths = if_else(n_days_since_1st_deaths >= 0, n_days_since_1st_deaths, NA_real_)
  )
```


View stats for Russia:

```{r}
countries_cases %>% 
  filter(country_region == "Russia") %>% 
  arrange(-n_days_since_1st_confirmed)

```

View stats for US:

```{r}
countries_cases %>% 
  filter(country_region == "US") %>% 
  arrange(-n_days_since_1st_confirmed)
```



### Enrich COVID-19 dataset with world population

```{r}
countries_cases %<>% 
  ## join w/ population dataset
  inner_join(
    world_population_2018 %>% rename(population_n = n), 
    by = c("country_region" = "country") 
  ) %>% 
  ## filter only countries with population greater than 1M
  filter(population_n > 1e6) %>% 
  ## calculate count of cases per 1M population
  mutate_at(
    vars(ends_with("_total")),
    list("per_1M" = ~ ./population_n*1e6)
  )
  
countries_cases %>% 
  filter(country_region == "Russia") %>% 
  arrange(-n_days_since_1st_confirmed) %>% 
  select(country_region, n_days_since_1st_confirmed, population_n, starts_with("confirmed_"))
```


### TOPs

Calculate countries stats whose populations were most affected by the virus:

```{r}
countries_cases_last <- countries_cases %>% 
  ## get last observation for country
  group_by(country_region) %>% 
  arrange(desc(observation_date)) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  ## filter countries with infected cases greatet than 1K
  filter(confirmed_total > 1000)
```



#### Top countries by infected cases 

```{r}
countries_cases_last %>% 
  arrange(-confirmed_total_per_1M) %>% 
  select(
    country_region, population_n,
    confirmed_total, confirmed_total_per_1M,
    n_days_since_1st_confirmed
  )
```


#### Top countries by active cases 

```{r}
countries_cases_last %>% 
  arrange(-active_total_per_1M) %>% 
  select(
    country_region, population_n,
    active_total, active_total_per_1M,
    n_days_since_1st_confirmed
  )
```


#### Top countries by fatal cases 

```{r}
countries_cases_last %>% 
  arrange(-deaths_total_per_1M) %>% 
  select(
    country_region, population_n,
    deaths_total, deaths_total_per_1M,
    n_days_since_1st_confirmed
  )
```



### Select countries to monitoring

Get top 20:

```{r}
top_n <- 20

observed_countries <- countries_cases_last %>% 
  arrange(desc(active_total_per_1M)) %>% 
  top_n(20) %>% 
  select(country_region) %>% 
  as_vector


# Add countries that we are interested in
observed_countries <- c(observed_countries, "US", "India", "Russia", "Mainland China", "South Korea", "Japan", "Iran") %>% unique
observed_countries %>% sort
```


#### Active cases per 1M population x # of days since 1st infected case

```{r warning=FALSE}
confirmed_cases_last <- countries_cases %>% 
  group_by(country_region) %>% 
  arrange(desc(observation_date)) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  transmute(
    country_region, 
    active_total_per_1M_last = active_total_per_1M,
    n_days_since_1st_confirmed
  )


ggplot(
    countries_cases %>% 
      filter(country_region %in% observed_countries) %>% 
      left_join(
        confirmed_cases_last,
        by = c("country_region", "n_days_since_1st_confirmed")
      ) %>% 
      mutate(
        plus_10_percent_per_day = 1.1^n_days_since_1st_confirmed,
        plus_33_percent_per_day = 1.33^n_days_since_1st_confirmed,
        plus_50_percent_per_day = 1.5^n_days_since_1st_confirmed,
        plus_100_percent_per_day = 2^n_days_since_1st_confirmed
      ),
    aes(x = n_days_since_1st_confirmed)
  ) +
  
  geom_line(aes(y = plus_10_percent_per_day), linetype = "dashed", color = "red", alpha = .2) +
  geom_line(aes(y = plus_33_percent_per_day), linetype = "dashed", color = "red", alpha = .33) +
  geom_line(aes(y = plus_50_percent_per_day), linetype = "dashed", color = "red", alpha = .5) +
  geom_line(aes(y = plus_100_percent_per_day), linetype = "dashed", color = "red", alpha = .9) +
  
  geom_line(aes(y = active_total_per_1M, color = country_region), show.legend = F) +
  geom_text(aes(y = active_total_per_1M_last, label = country_region), 
            hjust = 0.5,  vjust = -1) +
  
  xlim(c(10, 65)) +
  ylim(c(0, 1200)) +
  
  labs(x = "Number of days since 1st infected case", y = "Active cases per 1M population", 
       title = "COVID-19 Spread within Population", 
       subtitle = "By Top 20 countries with largest number of active cases", 
       caption = caption) +
  
  theme_minimal()
```


#### Active cases per 1M population x # of days since 1st fatal case

```{r warning=FALSE}
deaths_cases_last <- countries_cases %>% 
  group_by(country_region) %>% 
  arrange(desc(observation_date)) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  transmute(
    country_region, 
    active_total_per_1M_last = active_total_per_1M,
    n_days_since_1st_deaths
  )


ggplot(
  countries_cases %>% 
    filter(country_region %in% observed_countries) %>% 
    left_join(
      deaths_cases_last,
      by = c("country_region", "n_days_since_1st_deaths")
    ) %>% 
    mutate(
      plus_10_percent_per_day = 1.1^n_days_since_1st_deaths,
      plus_33_percent_per_day = 1.33^n_days_since_1st_deaths,
      plus_50_percent_per_day = 1.5^n_days_since_1st_deaths,
      plus_100_percent_per_day = 2^n_days_since_1st_deaths
    ),
    aes(x = n_days_since_1st_deaths)
  ) +
  
  geom_line(aes(y = plus_10_percent_per_day), linetype = "dashed", color = "red", alpha = .2) +
  geom_line(aes(y = plus_33_percent_per_day), linetype = "dashed", color = "red", alpha = .33) +
  geom_line(aes(y = plus_50_percent_per_day), linetype = "dashed", color = "red", alpha = .5) +
  geom_line(aes(y = plus_100_percent_per_day), linetype = "dashed", color = "red", alpha = .9) +
  
  geom_line(aes(y = active_total_per_1M, color = country_region), show.legend = F) +
  geom_text(aes(y = active_total_per_1M_last, label = country_region), 
            hjust = 0.5,  vjust = -1) +
  
  xlim(c(0, 40)) +
  ylim(c(0, 1000)) +
  
  labs(x = "Number of days since 1st fatal case", y = "Active cases per 1M population", 
       title = "COVID-19 Spread within Population", 
       subtitle = "By Top 20 countries with largest number of active cases", 
       caption = caption) +
  
  theme_minimal()
```
 


